# Rollout On Premise Reference Implementation
## Overview 
Rollout point to point security from cloud to devices is built on asymmetric key pair, the SDK gets bundled with a self signed certificate that contains a public key, that public key is extracted from the certificate on runtime and is used to verify that the data was signed with Rollout's private key stored safely on Rollout cloud (via aws).

The on premise private key feature allows Rollout customer to hold their own asymmetric key pair that will be used for the security mechanism, this way only server holding the private key (on premised) can sign the hot patches. 

More about Rollout security can be found here: https://rollout.io/security/

This project is a reference implementation for the on premise entity, it opens an endpoint ready for signning and responde to Rollout server signing request

## Installation

**Install node**
Download node.js from https://nodejs.org/en/download/ and install on your machine.

**Clone from git and install dependencies**
Clone Rollout's signer from the following git repository
 - `git clone https://github.com/rollout/node-rsa-signer.git`
 - `cd node-rsa-signer`
 - `npm install` to install all dependecies

### Quick start 
  Run customer signer:

```bash 
$ npm start
```
  Runs Rollout's customer code which is the signing remote service
 
```bash 
$ node rollout/simulate_rollout_signing_request.js http://localhost:4000/rollout/sign ./keys/535110d5fb598c7a01635d108ab69e54/certificate.cert // or npm run simulate
```

 Runs Rollout's mock which send sample configuration to remote signing url with the given certificate. 
 You can use it with different signing service implementation by replacing the url and the certificate arguments.
 Make sure to run this script only after the remote signining service is up and running.

  Test customer code
```bash
$ npm test
```
 Test the signing service (e.g. the customer part pf the service)
 
## More on the Signer
The project is a node.js project that use express as the web framework.

1. `npm start` is actually run customer/app.js which initiate application variables and modules and start the server (in customer/www/bin)
1. customer/app.js register a router (entry point) for all requests that will be `http://<this domain>/rollout`
1. Entry point (in customer/routes/rollout.js) 
1. Call for signing configuration send to `http://<this domain>/rollout/sign` with method=`POST` and body is: 

```json
{
  "data": {
   //Data that we like to sign with the private key
  },
  "certificateMd5": "535110d5fb598c7a01635d108ab69e54", //md5 value generated from running md5 on the certificate registered on rollout dashboard. Ususally act as a key to the private key in a local map.
  "responseURL": "http://localhost:3000/api/app-versions/:appId/signing_data/:transactionId" //The url which you should send the result too.
}
```

1. Signer verify the incoming certificate md5 points to a valid public key (reply with error if not)
1. Signer sign the incoming data and send it to the responseURL given in the request.

### Project structure
```c
|-- customer
    |-- bin
    |   `-- www // execution script
    |-- modules
    |   `-- signer.js //  sign configurations accorind to the information it gets from the request.
    |-- public
    |   `-- stylesheets
    |       `-- style.css 
    |-- routes
    |   |-- index.js // registers handler for showing the markup file on route /
    |   `-- rollout.js // register handler that sign data and send back to responseURL on route /sign
    |-- test
    |   |-- res
    |   |   |-- certificateMd5 
    |   |   |-- server.cert
    |   |   `-- server.pem
    |   `-- test.js
    |-- views 
    |   |-- error.hbs
    |   |-- index.hbs
    |   `-- layout.hbs
    |-- app.js // define application configurations and load the various middleware and routes
|-- keys
    |-- 535110d5fb598c7a01635d108ab69e54 //Certificate md5 - Folder holding corresponded certificate, private and public keys. Generated by `md5 certificate.cert` 
        |-- certificate.cert // certificate generated using `openssl req  -nodes -new -x509  -keyout private.key -out certificate.cert`
        |-- private.pem // private key generated using `openssl req  -nodes -new -x509  -keyout private.key -out certificate.cert`
        |-- public.pem // public key generated using `openssl x509 -inform pem -in certificate.cert -pubkey -noout > public.pem`
|-- node_modules //Node.js dependency libraries
|-- rollout //Mock which mimics rollout behaviour
    |-- hotPatch.js // Return an sample hot patch
    |-- RolloutMock.js // The class which do the logic of mimics Rollout.
    |-- simulate_rollout_signing_requet.js // Main controller that initiate rollout's mock
|-- README.md // This file
`-- package.json //  node dependencies test and start scripts
```
### Create private key and Certificate
You can create private key and certificate in one line using openssl

 - run the command: `openssl req  -nodes -new -x509  -keyout private_key.pem -out certificate.cert`
 - Answer the questions on the command prompt for generating the certificate.

On complete you should have private key in `private_key.pem` and certificate ready in `certificate.cert`
Please note that when loading certificate to Rollout dashboard you should omit the certificate header and footer (e.g. `-----BEGIN CERTIFICATE-----` and `-----END CERTIFICATE-----`)
